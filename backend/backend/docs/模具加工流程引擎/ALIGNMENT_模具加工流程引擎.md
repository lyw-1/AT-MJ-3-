# ALIGNMENT_模具加工流程引擎

## 1. 原始需求

### 1.1 业务背景
模具加工流程数字化系统需要实现完整的模具加工流程管理，包括：
- 模具加工状态机管理
- 加工工序流转控制
- 加工进度跟踪
- 质量检验流程
- 异常处理机制

### 1.2 核心功能需求
- 实现模具加工全生命周期状态管理
- 支持多工序流转和并行加工
- 提供加工进度实时监控
- 集成质量检验和异常处理
- 支持加工历史追溯

## 2. 项目特性规范

### 2.1 现有项目分析
**技术栈确认：**
- Spring Boot 2.7 + Spring Security + Spring Validation
- MyBatis Plus + 分页插件
- Redis + Spring Cache
- RocketMQ（可选，用于异步通知）
- Swagger/knife4j + 参数校验
- Lombok + MapStruct + Hutool

**现有架构模式：**
- 分层架构：Controller → Service → Mapper → Model
- 包结构：按模块划分（mold、part、inventory、equipment）
- 配置分离：开发/测试/生产环境配置
- API版本管理：v1/api/ 前缀

**已完成模块：**
- ✅ 用户权限管理模块（JWT + 角色权限）
- ✅ 操作日志审计功能
- ✅ 密码重置功能
- ✅ 模具管理基础框架（Mold、MoldType、MoldStatus）
- ✅ 生产任务管理基础框架（ProductionTask、ProductionRecord）

### 2.2 任务边界确认
**包含范围：**
- 模具加工状态机定义和实现
- 加工工序流转逻辑
- 加工进度跟踪API
- 质量检验流程集成
- 异常处理机制
- 相关数据库表设计和迁移

**排除范围：**
- 前端界面开发（仅提供API接口）
- 设备接口集成（预留接口）
- 报表统计功能（单独模块）
- 通知提醒功能（使用现有消息服务）

## 3. 需求理解

### 3.1 对现有项目的理解
基于现有代码分析：
1. **模具实体已存在**：Mold实体包含基础信息，但缺少加工流程相关字段
2. **生产任务框架已搭建**：ProductionTask和ProductionRecord提供基础
3. **权限系统完善**：可基于现有权限控制加工流程访问
4. **日志审计就绪**：可自动记录加工流程操作日志

### 3.2 技术约束识别
- 必须与现有Spring Boot架构保持一致
- 使用MyBatis Plus进行数据访问
- 集成Spring Cache进行状态缓存
- 遵循现有异常处理和响应格式
- 使用现有权限控制机制

## 4. 疑问澄清

### 4.1 技术实现疑问
**Q1: 状态机实现方式选择？**
- 选项A：使用Spring State Machine框架
- 选项B：自定义状态枚举+流程控制器
- **决策**：基于项目轻量级需求，选择自定义状态枚举+流程控制器

**Q2: 加工工序数据模型设计？**
- 是否需要支持动态工序配置？
- **决策**：基于制造业标准工序，采用预定义工序+可扩展设计

**Q3: 进度跟踪粒度？**
- 按工序级别跟踪还是更细粒度？
- **决策**：按工序级别跟踪，支持百分比进度

### 4.2 业务规则疑问
**Q4: 异常处理流程？**
- 是否需要支持多级审批？
- **决策**：基于角色权限的简单审批流程，支持异常记录和状态回滚

**Q5: 质量检验集成方式？**
- 是否每个工序都需要质量检验？
- **决策**：关键工序强制质量检验，普通工序可选

## 5. 智能决策策略

### 5.1 基于现有项目的决策
1. **状态机设计**：复用现有枚举模式，参考MoldStatus实现
2. **数据模型**：扩展Mold实体，新增加工流程相关字段
3. **API设计**：遵循现有RESTful规范，使用统一响应格式
4. **权限控制**：基于现有角色权限系统，新增加工流程相关权限

### 5.2 基于行业知识的决策
1. **加工流程标准**：参考制造业标准工序（设计→备料→粗加工→精加工→检验→入库）
2. **状态流转规则**：基于制造业最佳实践定义状态转换规则
3. **异常处理**：采用制造业常见的异常分类和处理流程

## 6. 需求理解确认

### 6.1 核心业务流程
```
模具创建 → 工艺设计 → 材料准备 → 粗加工 → 精加工 → 质量检验 → 成品入库
    ↓          ↓          ↓         ↓         ↓          ↓           ↓
  新建      设计中     备料中    加工中    加工中     检验中      已完成
```

### 6.2 关键功能点
1. **状态管理**：支持状态流转和状态历史记录
2. **进度跟踪**：实时显示加工进度和当前工序
3. **异常处理**：支持加工异常记录和处理
4. **质量检验**：集成质量检验流程和结果记录
5. **权限控制**：基于角色控制流程操作权限

## 7. 最终共识要点

### 7.1 技术实现共识
- 使用自定义状态机实现，避免引入复杂框架
- 基于现有MyBatis Plus架构进行数据持久化
- 集成Spring Cache优化状态查询性能
- 使用统一异常处理和日志记录

### 7.2 业务规则共识
- 支持标准加工工序流程
- 提供灵活的异常处理机制
- 集成质量检验流程
- 支持加工历史追溯

### 7.3 集成方案共识
- 与现有模具管理模块无缝集成
- 复用现有权限和用户管理系统
- 使用统一的消息通知机制
- 遵循现有API设计和响应格式

## 8. 验收标准

### 8.1 功能验收标准
- [ ] 模具加工状态机正常工作，支持状态流转
- [ ] 加工进度跟踪准确，实时更新当前工序
- [ ] 异常处理机制有效，支持异常记录和状态回滚
- [ ] 质量检验流程完整，检验结果可追溯
- [ ] 权限控制正确，不同角色有相应操作权限

### 8.2 技术验收标准
- [ ] API接口符合RESTful规范
- [ ] 数据库设计合理，支持高效查询
- [ ] 代码符合项目编码规范
- [ ] 单元测试覆盖核心业务逻辑
- [ ] 集成测试验证端到端流程

## 9. 风险评估

### 9.1 技术风险
- **状态机复杂度**：通过模块化设计降低复杂度
- **数据一致性**：使用事务保证关键操作的数据一致性
- **性能问题**：通过缓存和索引优化查询性能

### 9.2 业务风险
- **流程变更**：设计可扩展的流程配置机制
- **异常处理**：提供完善的异常处理和恢复机制
- **权限控制**：基于现有权限系统，降低权限管理风险

---

**文档状态**：✅ 对齐完成  
**下一步**：进入Architect阶段，设计系统架构