# 权限缓存刷新机制需求对齐文档

## 1. 项目上下文分析

### 1.1 现有项目结构和技术栈
- 框架：Spring Boot 2.7 + Spring Security
- 缓存：Redis + Spring Cache
- 权限模型：RBAC（基于角色的访问控制）
- 分层架构：Controller → Service → Mapper → Model

### 1.2 现有权限管理系统结构
- **用户管理**：UserService，管理用户基本信息
- **角色管理**：RoleService，管理角色信息
- **权限管理**：PermissionService，管理权限信息
- **用户角色关联**：UserRoleService，管理用户和角色的关联关系
- **权限缓存**：PermissionCacheService，管理用户权限缓存

### 1.3 现有缓存机制
- 使用Redis存储用户权限信息，键格式为 `user:permissions:{userId}`
- 已有权限缓存服务：PermissionCacheService，包含刷新和清除用户权限缓存的方法
- 已有权限缓存控制器：PermissionCacheController，提供刷新和清除用户权限缓存的API接口

### 1.4 权限变更触发点
- 用户角色分配/移除（UserRoleService）
- 角色权限分配/移除（PermissionMapper中的insertRolePermissions和deleteRolePermissions方法）
- 角色状态变更（RoleServiceImpl中的updateRoleStatus方法）

## 2. 需求理解确认

### 2.1 原始需求
- 任务13：权限缓存刷新机制设计
- 任务14：权限缓存刷新接口实现
- 任务15：权限变更事件监听

### 2.2 需求边界确认
- **范围**：实现权限变更时的缓存自动刷新机制，包括事件监听和缓存更新
- **目标**：确保权限变更后，用户权限缓存能够及时更新，保证权限控制的准确性
- **限制**：仅涉及权限缓存的刷新，不涉及权限模型的修改

### 2.3 需求理解
1. **权限缓存刷新机制**：当用户角色或角色权限发生变更时，需要及时刷新相关用户的权限缓存
2. **权限缓存刷新接口**：提供手动刷新用户权限缓存的API接口（已部分实现）
3. **权限变更事件监听**：实现权限变更事件的发布和监听，在权限变更时自动触发缓存刷新

### 2.4 疑问澄清
1. **事件机制选择**：Spring事件机制 vs 自定义事件总线？
   - 决策：使用Spring标准事件机制，符合Spring Boot最佳实践

2. **缓存刷新策略**：直接清除缓存 vs 重新计算并更新缓存？
   - 决策：根据现有代码，采用重新计算并更新缓存的策略

3. **权限变更粒度**：是否需要区分不同类型的权限变更？
   - 决策：根据变更类型发布不同的事件，实现精细化的缓存刷新

## 3. 技术实现方向

### 3.1 事件机制设计
- 设计权限变更相关的事件类
- 实现事件发布器
- 实现事件监听器，触发缓存刷新

### 3.2 缓存刷新策略
- 用户角色变更：刷新特定用户的权限缓存
- 角色权限变更：刷新拥有该角色的所有用户的权限缓存
- 角色状态变更：刷新拥有该角色的所有用户的权限缓存

### 3.3 接口完善
- 检查并完善现有的权限缓存刷新接口
- 确保接口的安全性和正确性

## 4. 与现有系统的集成
- 在UserRoleService中添加事件发布
- 在RoleServiceImpl中添加事件发布
- 完善PermissionServiceImpl中的方法实现
- 实现事件监听器，与PermissionCacheService集成