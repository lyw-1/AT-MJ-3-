# 6A工作流：权限管理模块功能增强需求共识文档

## 1. 明确的需求描述

### 1.1 密码重置功能
- **核心功能**：实现安全的密码重置流程，支持邮箱和手机号验证
- **流程设计**：
  1. 用户请求重置密码（提供用户名/邮箱/手机号）
  2. 系统验证用户存在性并发送验证链接/验证码
  3. 用户通过验证后设置新密码
  4. 重置成功后强制下次登录修改密码
- **安全要求**：
  - 验证令牌有效期15分钟
  - 密码长度至少8位，包含数字和字母
  - 重置后立即失效旧会话

### 1.2 用户锁定机制
- **核心功能**：防止暴力破解的自动锁定机制
- **触发条件**：连续5次登录失败
- **锁定时长**：30分钟自动解锁
- **管理员功能**：提供手动解锁接口
- **用户通知**：锁定时返回明确提示信息

### 1.3 操作日志审计
- **核心功能**：记录关键操作的审计日志
- **日志内容**：
  - 操作人信息（用户ID、用户名）
  - 操作时间和IP地址
  - 操作类型和描述
  - 操作对象和变更内容
  - 操作结果（成功/失败）
- **记录范围**：
  - 用户管理操作（创建、修改、删除、禁用）
  - 角色管理操作（创建、修改、删除）
  - 权限分配操作（角色分配、权限变更）
  - 系统配置修改

### 1.4 权限缓存刷新机制
- **核心功能**：确保权限变更后及时生效
- **触发场景**：
  - 用户角色变更
  - 角色权限变更
  - 手动触发刷新
- **实现方式**：
  - 清除相关用户的权限缓存
  - 强制重新加载权限信息
  - 提供批量刷新接口

## 2. 技术实现方案

### 2.1 密码重置功能
- **新增实体**：
  - `PasswordResetToken`：存储重置令牌信息
- **新增API**：
  - `/v1/api/auth/reset-password/request`：请求重置
  - `/v1/api/auth/reset-password/verify`：验证令牌
  - `/v1/api/auth/reset-password/confirm`：确认重置
- **服务层**：
  - 增强`AuthService`，添加重置流程相关方法
  - 使用Redis存储验证令牌和临时状态
- **工具类**：
  - 密码复杂度验证工具
  - 令牌生成和验证工具

### 2.2 用户锁定机制
- **现有功能增强**：
  - 修改`AuthServiceImpl.login()`方法，添加失败计数和锁定检查
- **Redis键设计**：
  - `login_fail_count:{username}`：记录失败次数
  - `user_locked:{userId}`：记录锁定状态
- **锁定流程**：
  - 每次登录失败递增计数
  - 达到阈值时设置锁定状态
  - 登录前检查锁定状态
  - 锁定过期自动解锁

### 2.3 操作日志审计
- **新增实体**：
  - `OperationLog`：操作日志表
- **新增服务**：
  - `OperationLogService`：日志记录和查询服务
- **AOP实现**：
  - 创建`OperationLogAspect`拦截关键操作
  - 使用注解标记需要记录的方法
- **查询功能**：
  - 提供按条件查询和分页查询接口
  - 支持导出和统计分析

### 2.4 权限缓存刷新机制
- **缓存设计**：
  - 在Redis中缓存用户权限信息
  - 键格式：`user_permissions:{userId}`
- **事件监听**：
  - 使用Spring事件机制监听权限变更
  - 创建`PermissionChangeEvent`事件
- **刷新策略**：
  - 用户角色变更时清除该用户缓存
  - 角色权限变更时清除所有相关用户缓存
  - 提供全局缓存刷新接口

## 3. 技术约束和集成方案

### 3.1 技术约束
- 所有实现必须兼容Spring Boot 2.7版本
- 使用MyBatis Plus进行数据库操作
- 密码加密使用BCryptPasswordEncoder
- 缓存使用Redis，需考虑分布式环境下的一致性
- 必须遵循现有项目的代码规范和架构模式

### 3.2 集成方案
- **数据库集成**：
  - 创建必要的表结构
  - 配置MyBatis Plus映射
- **安全集成**：
  - 确保与Spring Security无缝集成
  - 遵循现有认证流程
- **API集成**：
  - 遵循RESTful规范
  - 与现有API版本保持一致（v1/api/）
- **缓存集成**：
  - 统一使用RedisService进行缓存操作
  - 确保缓存键的命名规范

## 4. 任务边界限制

### 4.1 包含范围
- 密码重置的完整流程实现
- 基于Redis的用户锁定机制
- 操作日志的记录和查询功能
- 权限缓存的自动刷新机制
- 相关API文档和单元测试

### 4.2 排除范围
- 不包括消息推送功能（如邮件/短信发送）
- 不包括复杂的报表统计功能
- 不包括权限缓存的持久化存储
- 不包括高级的多因素认证

## 5. 验收标准

### 5.1 密码重置功能
- 能够成功请求并验证重置密码
- 验证令牌在15分钟后失效
- 新密码必须符合复杂度要求
- 重置成功后旧会话立即失效
- 测试用例覆盖正常、异常和边界情况

### 5.2 用户锁定机制
- 连续5次登录失败后自动锁定账户
- 锁定状态在30分钟后自动解除
- 管理员可以手动解锁账户
- 锁定状态正确反映在API响应中

### 5.3 操作日志审计
- 所有关键操作都有对应的审计日志
- 日志内容完整准确
- 能够按条件查询和分页展示日志
- 日志数据与实际操作一致

### 5.4 权限缓存刷新机制
- 用户角色变更后权限立即生效
- 角色权限变更后相关用户权限立即更新
- 手动刷新接口能够清除指定或全部缓存
- 缓存刷新不影响系统性能和稳定性

---

本文档基于现有项目分析和最佳实践制定，确认所有关键需求已明确，技术方案可行。