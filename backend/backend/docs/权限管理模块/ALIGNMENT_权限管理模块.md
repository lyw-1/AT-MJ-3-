# 6A工作流：权限管理模块功能增强需求对齐文档

## 1. 项目上下文分析

### 1.1 技术栈分析
- 框架：Spring Boot 2.7 + Spring Security + Spring Validation
- ORM：MyBatis Plus + 分页插件
- 缓存：Redis + Spring Cache
- 文档：Swagger/knife4j (已集成)
- 工具：Lombok + MapStruct + Hutool

### 1.2 现有系统结构
- 分层架构：Controller → Service → Mapper → Model
- 核心实体：User、Role、UserRole
- 认证机制：JWT Token + Redis存储
- 密码加密：BCryptPasswordEncoder
- 安全配置：无状态认证，CSRF禁用

### 1.3 现有功能分析
- 用户管理：创建、查询、更新、删除
- 角色管理：创建、查询、更新、删除
- 用户角色关联：分配、移除角色
- 认证服务：登录、登出、令牌刷新、令牌验证
- 密码处理：加密存储、基本重置功能

## 2. 需求理解确认

### 2.1 原始需求
- 实现密码重置功能
- 实现用户锁定机制（防止暴力破解）
- 添加操作日志审计表
- 实现权限缓存刷新机制

### 2.2 边界确认
- **密码重置功能**：基于邮箱/手机验证的安全重置流程
- **用户锁定机制**：基于失败登录次数的自动锁定机制
- **操作日志审计**：记录关键操作的执行情况和变更内容
- **权限缓存刷新**：在权限变更时自动刷新相关缓存

### 2.3 对现有项目的理解
- 已有基础用户实体结构，包含status字段（0-禁用，1-启用）
- 已有简单的密码重置方法，但缺少完整的重置流程
- 使用Redis存储令牌，但未用于登录失败计数
- 缺少操作日志记录功能
- 缺少权限缓存刷新机制

### 2.4 疑问澄清
- **密码重置方式**：通过邮箱还是手机验证？是否需要验证码？
- **用户锁定策略**：连续失败登录次数阈值？锁定时长？
- **操作日志范围**：哪些关键操作需要审计记录？
- **权限缓存范围**：需要刷新哪些类型的权限缓存？

## 3. 智能决策策略

### 3.1 密码重置功能
基于制造业系统特点和安全性要求，决定采用：
- 支持邮箱和手机号双重验证方式
- 生成临时令牌发送给用户进行验证
- 令牌有效期设置为15分钟
- 重置后强制用户首次登录时修改密码

### 3.2 用户锁定机制
- 设置连续失败登录次数阈值为5次
- 锁定时长设置为30分钟
- 在Redis中记录失败次数，设置过期时间
- 提供管理员手动解锁功能

### 3.3 操作日志审计
- 创建独立的操作日志表，记录操作人、操作类型、操作时间、操作内容等
- 记录范围：用户管理、角色管理、权限变更、重要配置修改
- 使用AOP拦截关键操作进行日志记录
- 提供日志查询和统计功能

### 3.4 权限缓存刷新
- 监听权限变更事件（角色、用户角色关联修改）
- 自动清除相关用户的权限缓存
- 提供手动刷新缓存的管理接口
- 确保缓存一致性，避免权限生效延迟

## 4. 关键决策点（需确认）

1. **密码复杂度要求**：是否需要强制密码复杂度？（长度、字符类型等）
2. **通知方式**：密码重置、账户锁定等事件是否需要通知用户？（系统通知/邮件）
3. **日志保留期限**：操作日志保留多久？是否需要定期清理？
4. **缓存策略**：权限缓存的具体有效期设置？

---

本文档将在得到关键决策点确认后，更新为最终的CONSENSUS文档。