# 权限缓存刷新机制需求共识文档

## 1. 需求描述

实现权限缓存刷新机制，确保在用户角色或角色权限发生变更时，相关用户的权限缓存能够及时更新，保证权限控制的准确性。系统需要提供手动刷新接口和自动刷新机制，以应对不同场景下的权限更新需求。

## 2. 技术实现方案

### 2.1 整体架构
- 使用Spring事件机制实现权限变更的通知
- 设计专门的事件监听器处理缓存刷新逻辑
- 与现有的PermissionCacheService集成，复用缓存刷新方法

### 2.2 核心组件设计

#### 2.2.1 事件类设计
1. **PermissionChangeEvent**：权限变更的基类事件
2. **UserRoleChangeEvent**：用户角色变更事件
3. **RolePermissionChangeEvent**：角色权限变更事件
4. **RoleStatusChangeEvent**：角色状态变更事件

#### 2.2.2 事件发布
- 在UserRoleService中的用户角色分配/移除方法中发布UserRoleChangeEvent
- 在RoleServiceImpl中的角色状态更新方法中发布RoleStatusChangeEvent
- 在完善后的PermissionServiceImpl中的角色权限分配方法中发布RolePermissionChangeEvent

#### 2.2.3 事件监听
- 实现PermissionCacheEventListener，监听所有权限变更事件
- 根据不同事件类型，调用PermissionCacheService相应的方法刷新缓存

### 2.3 缓存刷新策略

| 变更类型 | 影响范围 | 刷新策略 |
|---------|---------|--------|
| 用户角色分配/移除 | 特定用户 | 刷新单个用户权限缓存 |
| 角色权限分配/移除 | 拥有该角色的所有用户 | 刷新多个用户权限缓存 |
| 角色状态变更 | 拥有该角色的所有用户 | 刷新多个用户权限缓存 |

### 2.4 接口实现

#### 2.4.1 现有接口完善
- 确保现有的刷新接口能够正确处理各种场景
- 验证接口的安全性和权限控制

#### 2.4.2 新增功能
- 实现权限变更事件的发布和监听
- 实现自动缓存刷新逻辑

## 3. 任务边界限制

### 3.1 包含范围
- 权限变更事件的设计和实现
- 事件监听器的实现
- 与PermissionCacheService的集成
- 权限变更点的改造

### 3.2 排除范围
- 权限模型的修改
- 用户认证机制的修改
- 权限验证逻辑的修改

## 4. 验收标准

### 4.1 功能验收
1. **用户角色变更**：当为用户分配或移除角色时，该用户的权限缓存应自动刷新
2. **角色权限变更**：当为角色分配或移除权限时，拥有该角色的所有用户权限缓存应自动刷新
3. **角色状态变更**：当更新角色状态时，拥有该角色的所有用户权限缓存应自动刷新
4. **手动刷新**：通过API接口可以手动刷新指定用户或所有用户的权限缓存

### 4.2 性能验收
1. **响应时间**：单个用户权限缓存刷新应在100ms内完成
2. **批量刷新**：1000个用户的权限缓存刷新应在5秒内完成

### 4.3 稳定性验收
1. **异常处理**：事件处理失败不应影响原业务操作
2. **幂等性**：重复的缓存刷新请求不应导致错误

## 5. 技术约束

- 遵循Spring Boot 2.7的最佳实践
- 使用标准的Spring事件机制
- 与现有的Redis缓存机制集成
- 确保事务一致性

## 6. 集成方案

### 6.1 与现有组件集成
- 在现有服务类中添加事件发布代码
- 实现新的事件监听器类
- 复用现有的PermissionCacheService

### 6.2 配置要求
- 确保Spring事件机制正确配置
- 确保Redis连接正常
- 配置适当的日志记录

## 7. 风险评估

### 7.1 已识别风险
- **性能风险**：大量用户权限缓存同时刷新可能导致性能问题
  - 缓解措施：使用异步处理和批处理优化
- **事务一致性风险**：事件发布和业务操作可能不在同一事务中
  - 缓解措施：确保事件发布在事务提交后进行

### 7.2 风险缓解策略
- 对于大量用户的权限缓存刷新，考虑使用异步处理
- 实现适当的错误处理和重试机制
- 完善日志记录，便于问题排查