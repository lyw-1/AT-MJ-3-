# API 安全性文档

## 概述

本文档描述了模具加工流程数字化系统API的安全机制、最佳实践和安全指南。

## 认证与授权

### JWT Token认证

系统使用JSON Web Token (JWT)进行用户认证。

#### 获取Token

用户通过登录接口获取Token：

```
POST /api/auth/login
Content-Type: application/json

{
  "username": "用户名",
  "password": "密码"
}
```

成功响应：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "refresh_token_here",
    "expiresIn": 3600,
    "user": {
      "id": 1,
      "username": "用户名",
      "roles": ["ROLE_OPERATOR"]
    }
  }
}
```

#### 使用Token

在API请求的Header中添加Token：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Token刷新

当Token即将过期时，可以使用refreshToken获取新的Token：

```
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "refresh_token_here"
}
```

### 角色权限控制

系统基于角色的访问控制(RBAC)模型，定义以下角色：

| 角色 | 描述 | 权限 |
|------|------|------|
| ROLE_ADMIN | 系统管理员 | 所有权限 |
| ROLE_MANAGER | 车间主管 | 查看、管理、审核权限 |
| ROLE_OPERATOR | 操作员 | 查看、操作权限 |
| ROLE_VIEWER | 查看者 | 只读权限 |

#### 权限矩阵

| API | ADMIN | MANAGER | OPERATOR | VIEWER |
|-----|-------|---------|----------|--------|
| 创建流程 | ✓ | ✓ | ✓ | ✗ |
| 更新流程 | ✓ | ✓ | ✓ | ✗ |
| 删除流程 | ✓ | ✓ | ✗ | ✗ |
| 查看流程 | ✓ | ✓ | ✓ | ✓ |
| 开始流程 | ✓ | ✓ | ✓ | ✗ |
| 暂停流程 | ✓ | ✓ | ✓ | ✗ |
| 恢复流程 | ✓ | ✓ | ✓ | ✗ |
| 完成流程 | ✓ | ✓ | ✓ | ✗ |
| 取消流程 | ✓ | ✓ | ✗ | ✗ |
| 状态转换 | ✓ | ✓ | ✓ | ✗ |
| 更新进度 | ✓ | ✓ | ✓ | ✗ |
| 创建异常 | ✓ | ✓ | ✓ | ✗ |
| 处理异常 | ✓ | ✓ | ✓ | ✗ |
| 查看统计 | ✓ | ✓ | ✓ | ✓ |

## 数据安全

### 敏感数据处理

1. **密码安全**
   - 使用BCrypt加密存储用户密码
   - 密码传输必须使用HTTPS
   - 前端不缓存密码信息

2. **个人隐私信息**
   - 用户姓名、电话等敏感信息在传输时加密
   - 日志中不记录敏感信息
   - 数据库中的敏感信息加密存储

3. **业务数据保护**
   - 模具设计图纸等文件存储在安全文件系统
   - 文件访问权限严格控制
   - 文件下载记录审计日志

### 数据传输安全

1. **HTTPS协议**
   - 所有API请求必须通过HTTPS
   - 禁止HTTP协议访问生产环境
   - 使用TLS 1.2及以上版本

2. **请求签名**
   - 关键API使用请求签名验证
   - 签名算法：HMAC-SHA256
   - 签名有效期：5分钟

3. **数据加密**
   - 敏感数据字段使用AES加密
   - 加密密钥定期轮换
   - 密钥存储在安全配置中心

## 输入验证与防护

### 输入验证

1. **参数验证**
   - 所有API参数进行类型和格式验证
   - 使用Spring Validation注解进行验证
   - 自定义验证器处理复杂业务规则

2. **SQL注入防护**
   - 使用MyBatis参数化查询
   - 禁止动态SQL拼接
   - 定期进行SQL注入安全扫描

3. **XSS防护**
   - 输入内容进行HTML转义
   - 使用Content Security Policy (CSP)
   - 前端框架内置XSS防护

### 访问控制

1. **IP白名单**
   - 管理员API限制IP访问
   - 支持IP段配置
   - 异常IP访问告警

2. **请求频率限制**
   - 使用令牌桶算法限制API请求频率
   - 不同用户角色设置不同限制
   - 超出限制返回429状态码

3. **会话管理**
   - JWT Token有效期控制
   - 单用户最大会话数限制
   - 异常登录地点检测

## 安全审计

### 日志记录

1. **操作日志**
   - 记录所有API访问日志
   - 记录关键业务操作日志
   - 日志包含用户ID、IP、时间、操作内容

2. **安全日志**
   - 记录登录成功/失败日志
   - 记录权限验证失败日志
   - 记录异常访问尝试

3. **日志保护**
   - 日志文件加密存储
   - 日志定期归档
   - 日志访问权限控制

### 监控告警

1. **异常行为监控**
   - 短时间内大量API调用
   - 非工作时间API访问
   - 敏感操作频繁执行

2. **系统安全监控**
   - 系统漏洞扫描
   - 依赖库安全检查
   - 定期安全评估

## 安全最佳实践

### 开发安全

1. **代码安全**
   - 定期进行代码安全审查
   - 使用静态代码分析工具
   - 遵循安全编码规范

2. **依赖安全**
   - 定期更新第三方依赖
   - 使用依赖漏洞扫描工具
   - 及时修复已知漏洞

3. **配置安全**
   - 敏感配置加密存储
   - 不同环境使用不同配置
   - 配置变更审批流程

### 部署安全

1. **网络安全**
   - 使用防火墙限制端口访问
   - 配置DMZ区域隔离内外网
   - 网络流量监控

2. **服务器安全**
   - 定期更新系统补丁
   - 最小化安装软件包
   - 禁用不必要的服务

3. **容器安全**
   - 使用官方基础镜像
   - 定期更新镜像版本
   - 容器运行时安全配置

## 安全事件响应

### 事件分类

| 级别 | 描述 | 响应时间 |
|------|------|----------|
| 高危 | 系统被入侵、数据泄露 | 1小时内 |
| 中危 | 异常访问、权限滥用 | 4小时内 |
| 低危 | 扫描探测、轻微违规 | 24小时内 |

### 响应流程

1. **发现与报告**
   - 监控系统自动告警
   - 用户报告安全问题
   - 安全团队主动发现

2. **评估与分析**
   - 确定事件级别和影响范围
   - 收集和分析相关日志
   - 制定应急处理方案

3. **处置与恢复**
   - 采取紧急措施控制影响
   - 修复安全漏洞
   - 恢复系统正常运行

4. **总结与改进**
   - 编写事件报告
   - 分析根本原因
   - 完善安全措施

## 安全合规

### 合规要求

1. **数据保护法**
   - 遵守《网络安全法》
   - 遵守《数据安全法》
   - 遵守《个人信息保护法》

2. **行业标准**
   - ISO 27001信息安全管理体系
   - 等保2.0安全要求
   - 行业特定安全标准

3. **内部规范**
   - 公司安全管理制度
   - 数据分类分级标准
   - 安全事件处理流程

### 合规检查

1. **定期审计**
   - 每季度进行内部安全审计
   - 每年进行第三方安全评估
   - 不定期进行专项安全检查

2. **合规报告**
   - 定期生成合规报告
   - 向管理层汇报安全状况
   - 向监管机构提交必要报告

## 安全培训

### 培训内容

1. **安全意识培训**
   - 常见安全威胁识别
   - 安全事件报告流程
   - 个人安全防护措施

2. **安全技能培训**
   - 安全编码实践
   - 安全工具使用
   - 应急响应流程

3. **定期演练**
   - 安全事件应急演练
   - 钓鱼邮件测试
   - 安全知识考核

## 安全工具与资源

### 推荐工具

1. **安全扫描工具**
   - OWASP ZAP：Web应用安全扫描
   - Nessus：系统漏洞扫描
   - SonarQube：代码安全分析

2. **监控工具**
   - ELK Stack：日志收集与分析
   - Prometheus：系统监控
   - WAF：Web应用防火墙

3. **安全学习资源**
   - OWASP Top 10
   - CWE漏洞分类
   - 安全博客和论坛

## 联系方式

如有安全问题或建议，请联系：

- 安全团队邮箱：security@atmj.com
- 安全事件报告：incident@atmj.com
- 安全咨询热线：400-XXX-XXXX