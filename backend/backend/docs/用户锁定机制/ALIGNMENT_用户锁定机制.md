# 用户锁定机制对齐文档

## 项目和任务特性规范

### 项目背景
本项目是一个模具数字化管理系统，需要实现用户锁定机制以增强系统安全性，防止暴力破解攻击和异常登录行为。

### 任务目标
实现完整的用户锁定机制，包括：
1. 用户锁定机制设计（基于登录失败次数）
2. 用户锁定缓存设计（使用Redis）
3. 登录失败处理逻辑
4. 用户解锁接口实现

### 技术栈
- Spring Boot 2.7
- Spring Security
- Redis
- MyBatis Plus

## 原始需求

根据TODO_权限管理模块.md文件中的任务描述：
- 任务9: 用户锁定机制设计
- 任务10: 用户锁定缓存设计
- 任务11: 登录失败处理逻辑
- 任务12: 用户解锁接口实现

## 边界确认

### 明确任务范围
1. 基于现有代码实现用户锁定和解锁功能
2. 实现锁定相关的缓存设计
3. 实现登录失败次数累计和锁定逻辑
4. 提供管理员解锁用户接口

### 任务边界
- 不涉及用户注册功能修改
- 不涉及用户角色权限调整
- 不改变现有认证方式（JWT）
- 不修改密码加密策略

## 需求理解

### 现有项目理解
通过对现有代码的分析，发现系统已经有部分用户锁定相关实现：

1. **用户实体（User）**：包含必要的锁定字段
   - `loginFailedCount`：登录失败次数
   - `lockedUntil`：锁定时间
   - `status`：用户状态（0-禁用，1-启用）

2. **认证服务（AuthServiceImpl）**：
   - `checkUserLockStatus()`：检查用户锁定状态
   - `handleLoginFailure()`：处理登录失败，增加失败次数并锁定用户
   - `unlockUser()`：解锁用户账号

3. **控制器（AdminAuthController）**：
   - `/lock-user`：锁定/解锁用户账号接口

4. **异常处理（GlobalExceptionHandler）**：
   - `handleUserLockedException()`：处理用户锁定异常

### 缺失功能
1. 缓存设计：缺少Redis缓存配置和使用
2. 锁定配置：缺少可配置的锁定参数（失败次数阈值、锁定时长）
3. 锁定状态检查：虽然有检查方法，但调用场景可能需要补充
4. 解锁接口：虽然有`unlockUser()`方法，但可能需要更完整的实现

## 疑问澄清

1. **锁定参数配置问题**：锁定的最大失败次数和锁定时长是硬编码还是通过配置文件管理？
   - 解答：基于最佳实践，应通过配置文件管理，便于灵活调整

2. **缓存策略问题**：用户锁定信息是仅保存在数据库还是同时缓存在Redis中？
   - 解答：建议主要保存在数据库，Redis可用于缓存热点用户数据以提高性能

3. **锁定类型问题**：除了基于登录失败的锁定，是否需要支持管理员手动锁定？
   - 解答：现有代码已支持两种锁定方式：
     - 基于登录失败的自动锁定（通过`lockedUntil`字段）
     - 管理员手动锁定（通过设置`status`为0）

4. **解锁方式问题**：解锁方式包括自动过期解锁和管理员手动解锁，是否需要用户自行解锁机制？
   - 解答：暂不需要，通过管理员手动解锁和锁定时间自动过期即可

5. **日志记录问题**：是否需要记录详细的锁定/解锁日志？
   - 解答：是的，需要记录操作日志，包含操作者、被操作用户、操作类型、时间等信息

## 智能决策

### 决策1：锁定参数配置方案
- **选择**：使用配置文件管理锁定参数
- **理由**：提高灵活性，便于运维调整，符合12-Factor应用最佳实践
- **实现方式**：通过`@ConfigurationProperties`注解绑定配置

### 决策2：缓存设计方案
- **选择**：数据库为主，Redis缓存热点数据
- **理由**：数据库存储保证数据一致性，Redis缓存提高频繁访问用户的性能
- **实现方式**：创建`UserLockCacheConfig`配置类管理缓存参数

### 决策3：异常处理方案
- **选择**：使用专门的异常类型`UserLockedException`
- **理由**：便于全局异常处理和定制化错误消息
- **实现方式**：完善现有的异常处理逻辑，确保返回明确的错误信息

### 决策4：解锁接口实现
- **选择**：完善现有`unlockUser()`方法，增加日志记录和参数校验
- **理由**：现有方法功能基本完整，需要增强健壮性
- **实现方式**：在现有方法基础上添加完善的校验和日志记录