# 操作日志审计功能需求对齐文档

## 1. 原始需求

> 操作日志审计功能：基于现有的操作日志系统，构建完整的操作日志审计体系，实现对系统内所有用户操作的全面记录、查询、分析和追溯能力，确保操作可审计、数据可追溯，满足企业级应用的安全合规要求。

## 2. 边界确认

### 2.1 明确任务范围

✅ **日志自动记录**：基于现有的OperationLogAspect，确保系统内所有Controller层操作都被自动记录

✅ **日志查询增强**：扩展现有查询功能，支持多维度、复杂条件的日志查询

✅ **日志分析统计**：提供操作日志的统计分析功能，生成操作行为报表

✅ **日志安全审计**：针对敏感操作提供特殊标记和重点监控

✅ **日志管理功能**：完善日志的导出、清理、归档等管理功能

❌ **第三方日志系统集成**：本次不涉及与ELK等第三方日志系统的集成

❌ **日志实时告警**：本次不实现日志异常行为的实时告警功能

## 3. 需求理解

### 3.1 对现有项目的理解

#### 3.1.1 现有日志系统架构

**操作日志系统**：
- `OperationLogAspect.java`：AOP切面自动记录所有Controller操作
- `OperationLog.java`：操作日志实体类
- `OperationLogService.java`：操作日志服务接口
- `OperationLogServiceImpl.java`：操作日志服务实现
- `OperationLogMapper.java`：操作日志数据访问接口
- `OperationLogController.java`：操作日志管理控制器

**通用日志系统**：
- `Log.java`：通用日志实体类
- `LogService.java`：通用日志服务接口
- `LogServiceImpl.java`：通用日志服务实现
- `LogController.java`：通用日志控制器

#### 3.1.2 现有功能分析

1. **自动记录能力**：
   - 已有AOP切面自动记录所有Controller方法调用
   - 记录了用户信息、IP地址、操作类型、操作内容、操作结果等基本信息
   - 采用异步方式保存日志，不影响主业务流程

2. **基础查询功能**：
   - 支持分页查询
   - 支持按用户名、操作类型筛选
   - 支持批量删除和清空操作

3. **缺失功能**：
   - 缺少按时间范围查询的接口
   - 缺少用户行为统计分析
   - 缺少敏感操作识别和标记
   - 缺少日志导出功能
   - 缺少日志归档策略

### 3.2 对任务特性的理解

1. **全面性**：操作日志审计需要覆盖系统内所有用户操作，包括普通操作和敏感操作

2. **可追溯性**：每条日志记录需要包含足够的上下文信息，确保任何操作都可以被追溯到具体用户、时间、地点和操作内容

3. **性能要求**：日志记录不应明显影响系统性能，应采用异步、批量等优化手段

4. **安全合规**：满足企业级应用对操作审计的安全合规要求，确保数据完整性和不可篡改性

5. **可分析性**：提供灵活的查询和统计分析能力，支持安全审计和行为分析

## 4. 疑问澄清

### 4.1 已确认事项

1. **日志存储方式**：继续使用MySQL数据库存储操作日志，与现有实现保持一致

2. **敏感操作定义**：需要明确哪些操作被定义为敏感操作，例如：
   - 用户管理（创建、删除、修改权限）
   - 角色权限管理（修改角色权限）
   - 系统参数配置修改
   - 数据删除操作

3. **日志保留策略**：需要确定日志的保留期限和归档策略

### 4.2 待澄清事项

1. **日志统计分析的具体需求**：是否需要特定的统计维度或报表格式？

2. **日志导出格式**：日志导出是否需要支持特定格式（如CSV、Excel、PDF等）？

3. **权限控制**：哪些角色可以访问和管理操作日志？

4. **日志清理策略**：是否需要实现自动清理过期日志的定时任务？

5. **是否需要集成安全风险评估**：是否需要对异常操作行为进行风险评估和标记？

## 5. 项目理解

### 5.1 技术栈理解

- **Spring Boot 2.7**：基础框架
- **MyBatis Plus**：ORM框架，已用于日志实体的CRUD操作
- **Spring AOP**：已用于实现日志自动记录
- **Swagger/Knife4j**：API文档，已在控制器中使用
- **Lombok**：简化代码，已在实体类和服务类中使用

### 5.2 架构理解

项目采用典型的分层架构：
- Controller层：处理HTTP请求，调用Service层
- Service层：实现业务逻辑
- Mapper层：数据访问
- Entity层：数据模型
- Aspect层：切面编程，实现横切关注点（如日志记录）

## 6. 初步决策

1. **基于现有架构扩展**：在现有OperationLog系统基础上进行功能扩展，不重新开发

2. **敏感操作标记机制**：通过自定义注解方式标记敏感操作，在AOP切面中识别并特殊处理

3. **查询功能增强**：扩展OperationLogService和OperationLogController，增加多条件查询和时间范围查询

4. **统计分析功能**：新增统计分析相关的Service和Controller方法

5. **导出功能实现**：使用Apache POI实现Excel格式的日志导出

6. **定时清理任务**：实现基于Spring Task的定时清理过期日志功能