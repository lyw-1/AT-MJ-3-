<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mold.digitalization.dao.InspectionResultMapper">

    <!-- 根据流程ID查询检验结果 -->
    <select id="selectByProcessId" resultType="com.mold.digitalization.entity.InspectionResult">
        SELECT * FROM inspection_result 
        WHERE process_id = #{processId}
        ORDER BY inspect_time DESC
    </select>

    <!-- 根据检验项目查询检验结果 -->
    <select id="selectByInspectionItem" resultType="com.mold.digitalization.entity.InspectionResult">
        SELECT * FROM inspection_result 
        WHERE inspection_item = #{inspectionItem}
        ORDER BY inspect_time DESC
    </select>

    <!-- 根据检验结果查询检验记录 -->
    <select id="selectByResult" resultType="com.mold.digitalization.entity.InspectionResult">
        SELECT * FROM inspection_result 
        WHERE result = #{result}
        ORDER BY inspect_time DESC
    </select>

    <!-- 根据检验人员ID查询检验结果 -->
    <select id="selectByInspectorId" resultType="com.mold.digitalization.entity.InspectionResult">
        SELECT * FROM inspection_result 
        WHERE inspector_id = #{inspectorId}
        ORDER BY inspect_time DESC
    </select>

    <!-- 根据时间范围查询检验结果 -->
    <select id="selectByTimeRange" resultType="com.mold.digitalization.entity.InspectionResult">
        SELECT * FROM inspection_result 
        WHERE inspect_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY inspect_time DESC
    </select>

    <!-- 统计检验结果数量 -->
    <select id="countInspectionResults" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM inspection_result
    </select>

    <!-- 统计各检验项目结果数量 -->
    <select id="countByInspectionItem" resultType="java.util.Map">
        SELECT inspection_item, COUNT(*) as count 
        FROM inspection_result 
        GROUP BY inspection_item
    </select>

    <!-- 统计各检验结果数量 -->
    <select id="countByResult" resultType="java.util.Map">
        SELECT result, COUNT(*) as count 
        FROM inspection_result 
        GROUP BY result
    </select>

    <!-- 统计流程的检验结果数量 -->
    <select id="countByProcessId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM inspection_result 
        WHERE process_id = #{processId}
    </select>

    <!-- 统计流程的合格率 -->
    <select id="calculatePassRate" resultType="java.lang.Double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0 
                ELSE SUM(CASE WHEN result = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) 
            END as pass_rate
        FROM inspection_result 
        WHERE process_id = #{processId}
    </select>

    <!-- 删除指定流程的检验结果 -->
    <delete id="deleteByProcessId">
        DELETE FROM inspection_result WHERE process_id = #{processId}
    </delete>

    <!-- 删除指定时间之前的检验结果 -->
    <delete id="deleteBeforeTime">
        DELETE FROM inspection_result WHERE inspect_time &lt; #{time}
    </delete>

</mapper>