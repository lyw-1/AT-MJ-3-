# 服务器配置
spring.profiles.active=dev
server.port=8082
server.servlet.context-path=/
# 允许覆盖重复的 Bean 定义（临时解决测试/安全配置导致的 metaDataSourceAdvisor 重复注册问题）
spring.main.allow-bean-definition-overriding=true

# 数据库连接配置（使用MySQL数据库）
spring.datasource.url=jdbc:mysql://localhost:3306/mold_digitalization?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=Root@2023
# 禁用SQL初始化，使用Flyway进行数据库迁移
spring.sql.init.mode=never

# HikariCP连接池配置
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.pool-name=HikariCP-MoldDigitalization
spring.datasource.hikari.leak-detection-threshold=60000

# MyBatis-Plus配置
mybatis-plus.mapper-locations=classpath*:mapper/*.xml
mybatis-plus.type-aliases-package=com.mold.digitalization.entity,com.atmj.mold.digitization.entity
mybatis-plus.configuration.map-underscore-to-camel-case=true
mybatis-plus.configuration.cache-enabled=false
mybatis-plus.global-config.db-config.id-type=auto

# Redis配置
spring.redis.host=localhost
spring.redis.port=6379
# spring.redis.password=Redis@2023
spring.redis.database=0
spring.redis.timeout=60000
spring.redis.lettuce.pool.max-active=8
spring.redis.lettuce.pool.max-wait=-1
spring.redis.lettuce.pool.max-idle=8
spring.redis.lettuce.pool.min-idle=0

# 关闭 Redis 使用（无Redis环境下运行，走No-Op/内存实现）
# 如需启用，请改为 true 并确保本地或远端 Redis 可用
app.redis.use=false

# 缓存类型：在禁用 Redis 时，改为使用内存缓存（ConcurrentMapCacheManager）以避免连接 Redis
spring.cache.type=simple

# 允许 Spring Data Redis 自动配置以创建 RedisConnectionFactory 与 RedisTemplate
# spring.autoconfigure.exclude=

# 显式关闭 Spring Session 的存储（防止默认选择 Redis）
spring.session.store-type=none

# RabbitMQ配置
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=${RABBITMQ_USERNAME:admin}
spring.rabbitmq.password=${RABBITMQ_PASSWORD:changeMe!}
spring.rabbitmq.virtual-host=/

# RabbitMQ连接池配置
rabbitmq.pool.max-connections=50
rabbitmq.pool.initial-connections=5
rabbitmq.pool.idle-timeout-ms=60000
rabbitmq.pool.connection-max-lifetime-ms=1800000
rabbitmq.pool.acquire-timeout-ms=10000
rabbitmq.pool.health-check-interval-ms=30000

# 日志清理配置
log.clean.enabled=true
log.clean.retentionDays=90
log.clean.criticalRetentionDays=365
log.clean.cron=0/30 * * * * ?

# 监控配置
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=always
management.info.env.enabled=true

# 根据app.redis.use属性动态启用/禁用Redis健康检查
management.health.redis.enabled=${app.redis.use:true}

# JWT配置
jwt.secret=9VfaLz1CunRStZOARq1UrEXnwgbz3gJeO4Sqmoy5Iw0=
jwt.expiration=86400000
jwt.refresh-expiration=2592000000

# 启用Flyway自动配置
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.out-of-order=true
spring.flyway.validate-on-migrate=false
spring.flyway.encoding=UTF-8
spring.flyway.table=flyway_schema_history
spring.flyway.baseline-version=1.0.0

# 开发环境放行开关（仅针对流程状态机接口）
# true: 允许未认证访问 /api/process-state-machine/** 接口（仅用于本地开发联调）；
# false: 关闭放行，所有接口按正常鉴权处理。
app.security.dev.bypass.processStateMachine=true
# 开发环境：Dev-Token 写操作联调开关与令牌值（生产必须关闭或移除）
app.security.dev.token.enabled=true
app.security.dev.token.value=dev-123
app.security.dev.bypass.departments=true

# 开发环境：出入库记录查询GET放行
app.security.dev.bypass.storageRecords=true
app.security.dev.bypass.roles=true
app.security.dev.bypass.initialParameters=true
app.security.dev.bypass.users=true

# 日志配置
logging.level.root=INFO
logging.level.com.mold.digitalization=DEBUG
logging.level.com.mold.process=DEBUG
# 增加Spring SQL初始化的日志级别，查看SQL初始化过程
logging.level.org.springframework.boot.sql.init=DEBUG
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
# 日志编码配置
logging.charset.console=UTF-8
logging.charset.file=UTF-8
# SQL初始化配置已移至application-dev.properties
# 允许跨域
spring.mvc.dispatch-options-request=true
spring.mvc.cors.allowed-origins=*
spring.mvc.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
spring.mvc.cors.allowed-headers=*

# Flyway数据库迁移配置
# Flyway配置已移至application-dev.properties
# spring.flyway.enabled=true
# spring.flyway.locations=classpath:db/migration
# spring.flyway.baseline-on-migrate=true
# spring.flyway.out-of-order=true
# spring.flyway.validate-on-migrate=false
# spring.flyway.encoding=UTF-8
# spring.flyway.table=flyway_schema_history
# spring.flyway.baseline-version=1.0.0
# 通过 Spring SQL 初始化在启动时执行 schema 变更（开发环境）
# 开发环境的SQL初始化配置已移至application-dev.properties
spring.sql.init.continue-on-error=true

# 文件上传配置
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=100MB

# 统一请求/响应编码
server.tomcat.uri-encoding=UTF-8
spring.http.encoding.enabled=true
spring.http.encoding.force=true
spring.http.encoding.charset=UTF-8

# Swagger/Knife4j 兼容性配置
# 使用默认的路径匹配策略，Spring Boot 3 推荐使用 PathPatternParser
# spring.mvc.pathmatch.matching-strategy=ant_path_matcher
# 显式启用 Knife4j 文档页面，确保 /doc.html 可用
knife4j.enable=true

# 操作日志清理策略配置
log.clean.enabled=true
log.clean.retention-days=90
log.clean.cron=0 0 2 * * ?
log.clean.critical-retention-days=365

# 敏感操作级别定义
log.sensitive.level.critical=user:delete,role:delete,permission:delete
log.sensitive.level.high=user:update,password:change,role:update,setting:change
log.sensitive.level.normal=login,logout,data:query

# 邮件服务配置
spring.mail.host=smtp.example.com
spring.mail.port=25
spring.mail.username=system@example.com
spring.mail.password=${MAIL_PASSWORD:your_email_password}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.default-encoding=UTF-8
mail.sender=system@example.com
mail.sender.name=模具数字化系统
# 用户锁定机制配置
user.lock.max-failed-attempts=5
user.lock.duration-minutes=30
user.lock.cache-enabled=true
user.lock.cache-expire-minutes=60
user.lock.failure-count-expire-minutes=10
user.lock.unlock-task-interval-minutes=10
